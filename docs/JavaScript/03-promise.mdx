---
title: "ã€AJAX_ES6ã€‘Promise"
sidebar_position: 3
---

> è€Œç‚ºäº†è§£æ±ºã€Œcallback åœ°ç„ã€(callback hell)å•é¡Œï¼ŒES6å°±å‡ºç¾äº† promise æ–¹æ³•

## ğŸŸ§ ä»€éº¼æ˜¯ Promiseï¼Ÿ

- <Highlight color="#1877F2">Promise æ˜¯ä¸€å€‹ç‰©ä»¶(åªæ˜¯ä¸€å€‹ç‹€æ…‹å®¹å™¨)ï¼Œç”¨ä¾†ã€Œä»£è¡¨ä¸€å€‹æœªä¾†æ‰æœƒçŸ¥é“çµæœçš„å€¼ã€ã€‚</Highlight>

- > Promise åªè² è²¬ã€Œè¨˜éŒ„ç‹€æ…‹ã€

| ç‹€æ…‹        | ä¸­æ–‡  | æ„æ€      |
| --------- | --- | ------- |
| pending   | ç­‰å¾…ä¸­ | é‚„ä¸çŸ¥é“çµæœ  |
| fulfilled | æˆåŠŸ  | çŸ¥é“çµæœæ˜¯æˆåŠŸ |
| rejected  | å¤±æ•—  | çŸ¥é“çµæœæ˜¯å¤±æ•— |

- âš ï¸ ä¸€æ—¦é€²å…¥æˆåŠŸæˆ–å¤±æ•—
- âš ï¸ æ°¸é ä¸æœƒå†è®Š

:::tip
ä¸€å€‹ Promise ä¸€é–‹å§‹ä¸€å®šæ˜¯ç­‰å¾…ä¸­

ç­‰äº‹æƒ…çµæŸå¾Œ

åªæœƒèµ°å‘æˆåŠŸæˆ–å¤±æ•—å…¶ä¸­ä¸€æ¢è·¯
:::

- Doï¼ˆå¯¦éš›åœ¨åšä»€éº¼ï¼‰
  - æ‹¿åˆ°ä¸€å€‹ Promise
  - å¹«å®ƒç™»è¨˜æˆåŠŸèˆ‡å¤±æ•—æ™‚çš„åæ‡‰

- Whatï¼ˆå¯¦éš›ç™¼ç”Ÿä»€éº¼ï¼‰
  - ä»»å‹™åœ¨èƒŒæ™¯è·‘
  - Promise ç‹€æ…‹æ”¹è®Š
  - å°æ‡‰çš„ handler è¢«è§¸ç™¼

- Howï¼ˆæ€éº¼è§¸ç™¼ï¼‰
  - æˆåŠŸ â†’ é€² fulfilled â†’ then
  - å¤±æ•— â†’ é€² rejected â†’ catch

- Whyï¼ˆç‚ºä»€éº¼è¦é€™æ¨£ï¼‰
  - æŠŠã€Œæœªä¾†çš„å€¼ã€ç•¶æˆç¾åœ¨å¯ä»¥æ“ä½œçš„æ±è¥¿
  -   å¯ä»¥ä¸²æ¥ã€å‚³éã€çµ±ä¸€éŒ¯èª¤è™•ç†
  - è§£æ±º callback åœ°ç„

## ğŸŸ¦ å»ºæ§‹ç¬¬ä¸€å€‹ promise

- Promiseæ¶æ§‹åœ–

```mermaid
flowchart TD
  A["å»ºç«‹new Promise(æˆ‘è²·çš„ä¸€å¼µæ¨‚é€)"] --> B["ç­‰å¾…ä¸­ pending(é‚„æ²’é–‹ç)"]
  B -->|æˆåŠŸresolved ä¸­çæœ‰éŒ¢| C["æˆåŠŸå®Œæˆ"]
  B -->|å¤±æ•—reject æ²’ä¸­| D["å¤±æ•—å®Œæˆ"]

  C --> E["å‘¼å« .then(data) æˆ‘å…ˆç™»è¨˜å¥½ï¼Œç­‰ä½ æˆåŠŸæ™‚å†é€šçŸ¥æˆ‘"]
  D --> F["å‘¼å« .catch(error) æˆ‘å…ˆç™»è¨˜å¥½ï¼Œç­‰ä½ å¤±æ•—æ™‚å†é€šçŸ¥æˆ‘"]

  classDef promise fill:#3f51b5,color:#fff
  classDef pending fill:#90caf9,color:#000
  classDef fulfilled fill:#66bb6a,color:#000
  classDef rejected fill:#ef5350,color:#000
  classDef handler fill:#333,color:#fff

  class A promise
  class B pending
  class C fulfilled
  class D rejected
  class E,F handler

```

--- 

new Promise æ˜¯åœ¨ã€Œå®£å‘Šä¸€å€‹è¦å‰‡ã€ï¼š
æœªä¾†ä»€éº¼æ™‚å€™æˆåŠŸã€ä»€éº¼æ™‚å€™å¤±æ•—ã€‚

```js
const checkScore = new Promise((resolve, reject) => {//pending
   // åœ¨é€™è£¡æ˜¯ Promise çš„ã€Œè£åˆ¤å®¤ã€ï¼>æ±ºå®šï¼šä»€éº¼æ¢ä»¶ä¸‹ æˆåŠŸ or ä»€éº¼æ¢ä»¶ä¸‹ å¤±æ•—
   resolve("æˆåŠŸäº†");
})
```
:::danger
- JavaScript ç«‹åˆ»åšäº† 3 ä»¶äº‹ï¼ˆåŒæ­¥ï¼‰
  - å»ºç«‹ä¸€å€‹ Promise ç‰©ä»¶
  - ç‹€æ…‹ä¸€é–‹å§‹å°±æ˜¯ã€Œç­‰å¾…ä¸­ã€
  - ç«‹åˆ»åŸ·è¡Œå‚³é€²å»çš„é‚£å€‹ function

- âš ï¸ æ³¨æ„ï¼š
  - ğŸ‘‰ é€™å€‹ function æ˜¯ã€ŒåŒæ­¥åŸ·è¡Œã€çš„
:::

### 0ï¸âƒ£ ã€Œç™»è¨˜èª°è¦æ¥çµæœã€

```js
const checkScore = new Promise((resolve, reject) => {//pending
   // åœ¨é€™è£¡æ˜¯ Promise çš„ã€Œè£åˆ¤å®¤ã€ï¼>æ±ºå®šï¼šä»€éº¼æ¢ä»¶ä¸‹ æˆåŠŸ or ä»€éº¼æ¢ä»¶ä¸‹ å¤±æ•—
   resolve("æˆåŠŸäº†");
})
```

:::tip
é€™æ®µç¨‹å¼ç¢¼åšäº†ä»€éº¼ï¼Ÿ

1. Promise è¢«å»ºç«‹

2. executor ç«‹åˆ»åŸ·è¡Œ

3. resolve() è¢«å‘¼å«

4. Promise ç‹€æ…‹è®Šæˆã€ŒæˆåŠŸå®Œæˆã€

5. Promise è£¡é¢è¨˜ä½äº†ã€ŒæˆåŠŸäº†ã€

- ğŸ‘‰ ä½†æ²’æœ‰ä»»ä½•æ±è¥¿è¢«å°å‡ºä¾†
- ç‚ºä»€éº¼ï¼Ÿ
  - å› ç‚ºæˆ‘é‚„æ²’ã€Œç™»è¨˜èª°è¦æ¥çµæœã€ã€‚
:::

### 1ï¸âƒ£ ã€Œç™»è¨˜èª°è¦æ¥çµæœã€=> åŠ ä¸Š .then()ï¼Œçœ‹æ¸…æ¥šã€Œåˆ†å·¥ã€
```js
const p = new Promise((resolve, reject) => {
  resolve("æˆåŠŸäº†");
});

p.then(data => {
  console.log(data);
});

```

- new Promiseï¼šæ±ºå®šçµæœæ˜¯ä»€éº¼

- .then()ï¼šæ±ºå®šçµæœè¦æ€éº¼ç”¨

### 2ï¸âƒ£ å¸¸è¦‹éŒ¯èª¤
- ğŸ‘‰ é€™å€‹ Promise æ˜¯æˆåŠŸé‚„æ˜¯ç­‰å¾…ä¸­ï¼Ÿ
  - æ°¸é æ˜¯ç­‰å¾…ä¸­
```js
new Promise((resolve, reject) => {
  return "æˆåŠŸ";
});

```

- Promise å®Œå…¨ä¸åœ¨ä¹ executor çš„ return å€¼ã€‚

:::danger
- é€è¡Œç™¼ç”Ÿäº†ä»€éº¼
  - 1. å»ºç«‹ä¸€å€‹ Promise
  - 2. Promise ç‹€æ…‹ä¸€é–‹å§‹æ˜¯ã€Œç­‰å¾…ä¸­ã€
  - 3. executor function ç«‹åˆ»åŒæ­¥åŸ·è¡Œ
  - 4. return "æˆåŠŸ" è¢«åŸ·è¡Œ
  - 5. æ²’æœ‰äººå‘¼å« resolve æˆ– reject

- ğŸ‘‰ Promise æ°¸é åœåœ¨ç­‰å¾…ä¸­
:::

| å¯«æ³•              | Promise ç‹€æ…‹ |
| --------------- | ---------- |
| `return "æˆåŠŸ"`   | ç­‰å¾…ä¸­        |
| `resolve("æˆåŠŸ")` | æˆåŠŸå®Œæˆ       |
| `reject("éŒ¯èª¤")`  | å¤±æ•—å®Œæˆ       |
| ä»€éº¼éƒ½ä¸åš           | æ°¸é ç­‰å¾…       |

---

```js
new Promise((resolve, reject) => {
  resolve("æˆåŠŸ");
  return "å¤±æ•—";
});

```

:::tip
- Promise åªè½ç¬¬ä¸€æ¬¡è¢«å‘¼å«çš„ resolve / rejectã€‚

- ç²¾æº–åŸ·è¡Œæµç¨‹ï¼ˆç…§æ™‚é–“é †åºï¼‰
- 1. å»ºç«‹ Promiseï¼ˆç‹€æ…‹ï¼šç­‰å¾…ä¸­ï¼‰

- 2. executor åŒæ­¥åŸ·è¡Œ

- 3. resolve("æˆåŠŸ") è¢«å‘¼å«

- 4. Promise ç‹€æ…‹ â†’ æˆåŠŸå®Œæˆ

- 5. Promise è¨˜ä½å€¼ï¼šã€ŒæˆåŠŸã€

- 6. return "å¤±æ•—" è¢«åŸ·è¡Œ

âš ï¸ Promise å®Œå…¨å¿½ç•¥
- executor çµæŸ

- ğŸ‘‰ Promise æ—©å°±å®šå‹äº†

- ğŸ”’ Promise ç‹€æ…‹é–å®šè¦å‰‡
  - ç¬¬ä¸€æ¬¡ resolve æˆ– reject å°±é–æ­»
  - å¾Œé¢çš„ resolve / reject / return
  - å…¨éƒ¨ç„¡æ•ˆ
:::

### 3ï¸âƒ£ æ¸¬é©—3

```js
new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve("æˆåŠŸ");
  }, 0);
  reject("å¤±æ•—");
});

```

- æ˜¯å¤±æ•—ç‹€æ…‹

> Promise åªçœ‹ã€Œèª°å…ˆå‘¼å« resolve / rejectã€ï¼Œä¸çœ‹èª°å¯«åœ¨å‰é¢ã€‚


| å¯«æ³•                            | çµæœ   |
| ----------------------------- | ---- |
| `resolve("A"); resolve("B");` | æˆåŠŸ A |
| `reject("éŒ¯"); resolve("å¥½");`  | å¤±æ•—   |
| `resolve("å¥½"); reject("éŒ¯");`  | æˆåŠŸ   |
| `return "å€¼"`                  | æ²’å½±éŸ¿  |

### 4ï¸âƒ£ æ¸¬é©—é¡Œ

```js
new Promise((resolve, reject) => {
  setTimeout(() => reject("éŒ¯èª¤"), 0);
  setTimeout(() => resolve("æˆåŠŸ"), 0);
});

```

:::tip
- å…©å€‹éƒ½æ˜¯ 0ï¼Œä¸æ˜¯åŒæ™‚è·‘ï¼›

- èª°ã€Œå…ˆè¢«æ’é€²ä½‡åˆ—ã€å…ˆåŸ·è¡Œã€ï¼Œèª°å°±å…ˆæ”¹ç‹€æ…‹ã€‚

- åœ¨é€™æ®µç¨‹å¼ç¢¼è£¡ï¼š
  - ç¬¬ä¸€å€‹ setTimeout å…ˆè¨»å†Š
  - ç¬¬äºŒå€‹ setTimeout å¾Œè¨»å†Š
  - ä½‡åˆ—æ˜¯ å…ˆé€²å…ˆå‡º

- ğŸ‘‰ ç¬¬ä¸€å€‹ callback å…ˆè·‘ â†’ reject("éŒ¯èª¤") å…ˆç™¼ç”Ÿ â†’ Promise ç«‹åˆ»é–æ­»
:::

```mermaid
flowchart TD
  A["è¨»å†Šç¬¬ä¸€å€‹ timer"] --> B["è¨»å†Šç¬¬äºŒå€‹ timer"]
  B --> C["ä½‡åˆ—å…ˆé€²å…ˆå‡º"]
  C --> D["å…ˆåŸ·è¡Œ reject"]
  D --> E["Promise å¤±æ•—é–å®š"]
  E --> F["resolve è¢«å¿½ç•¥"]

  classDef step fill:#90caf9,color:#000
  classDef reject fill:#ef5350,color:#000
  classDef lock fill:#333,color:#fff

  class A,B,C step
  class D reject
  class E,F lock

```
---

## ğŸŸ¦ æª¢æŸ¥æˆç¸¾åˆ†æ•¸

```js
const checkScore = new Promise((resolve, reject) => {
  console.log(`====æ­£åœ¨æ‰¹æ”¹ä¸­====`)
  setTimeout(() =>{
    const score = Math.round(Math.random() * 100);
    if(score >= 60) {
      resolve(score)
    } else {
      reject("ä¸åŠæ ¼")
    }
  }, 2000)
})

checkScore
  .then(data => console.log(data))
  .catch(error => console.log(error))
```

### 0ï¸âƒ£ promiseå¸¶åƒæ•¸

```js
const checkScore = (score) => {
  return new Promise((resolve, reject) => {
    console.log(`====æ­£åœ¨è§€å¯Ÿæ˜¯å¦åŠæ ¼====`)
    setTimeout(() =>{
        // const score = Math.round(Math.random() * 100);
        if(score >= 60) {
          resolve(score);
        } else {
          reject("ä¸åŠæ ¼");
        }
      }, 2000)
  })
}

checkScore(80)
  .then(data => console.log(data))
  .catch(error => console.log(error))
```


### 1ï¸âƒ£ æ’°å¯«catchæµç¨‹ 
```js
const correctTest = (name) => {
  console.log("æ‰¹æ”¹æˆç¸¾ä¸­");
  return new Promise((reslove, reject) => {
    setTimeout(() => {
      const score = Math.round(Math.random() * 100);
      if (score >= 60) {
        resolve({
          name,
          score
        });
      } else {
        reject("ä½ å·²é”åˆ°é€€å­¸é–€æª»");
      }
    }, 2000);
  });
};

correctTest("å°æ˜")
  .then((data) => console.log(data))
  .catch((error) => console.log(error));
```

### 2ï¸âƒ£ promise chain å¯«æ³• 
<Highlight color="#EF6C00">ä¸€å€‹ thenï¼Œåªæœƒæ¥æ”¶åˆ°ã€Œä¸Šä¸€å€‹ Promise resolve çš„å€¼ã€</Highlight> 

```js
const correctTest = (name) => {
  console.log("æ‰¹æ”¹æˆç¸¾ä¸­");

  return new Promise((resolve, reject) => {
    setTimeout(() => {
      const score = Math.round(Math.random() * 100);

      if (score >= 60) {
        resolve({ name, score });
      } else {
        reject("ä½ å·²é”åˆ°é€€å­¸é–€æª»");
      }
    }, 1000);
  });
};

const checkReward = (data) => {
  console.log("æ­£åœ¨æª¢æŸ¥èª°æŠ½ä¸­çä¸­");

  return new Promise((resolve) => {
    setTimeout(() => {
      if(data.score >= 90) {
        resolve(`${data.name}ç²å¾—é›»å½±ç¥¨`);
      } else if(data.score >= 60 && data.score <90) {
        resolve(`${data.name}ç²å¾—å˜‰ç`);
      }
    }, 1000);
  });
};

correctTest("å°æ˜")
  .then((data) => {
    return checkReward(data);
  }) //åªè¦ä½ åœ¨ then è£¡ return Promise
  .then((reward) => {
    //å¤–å±¤ then å°±æœƒã€Œç­‰é€™å€‹ Promise çµæŸã€
    console.log(reward);
  })
  .catch((error) => {
    console.log(error);
  });
```

- then æœƒå›å‚³ä¸€å€‹æ–°çš„ Promiseã€‚
- å¦‚æœåœ¨ then è£¡ return ä¸€å€‹ Promise
- å¤–å±¤ then å°±æœƒç­‰å¾…å®ƒå®Œæˆï¼Œä¸¦æŠŠ resolve çš„å€¼å‚³çµ¦ä¸‹ä¸€å€‹ then

### 3ï¸âƒ£ promise catch å¤šæ¢ä»¶è¨­è¨ˆ

```js
const correctTest = (name) => {
  console.log("æ‰¹æ”¹æˆç¸¾ä¸­");

  return new Promise((resolve, reject) => {
    setTimeout(() => {
      const score = Math.round(Math.random() * 100);

      if (score >= 20) {
        resolve({ name, score });
      } else {
        reject("ä½ å·²é”åˆ°é€€å­¸é–€æª»");
      }
    }, 1000);
  });
};

const checkReward = (data) => {
  console.log("æ­£åœ¨æª¢æŸ¥èª°æŠ½ä¸­çä¸­");

  return new Promise((resolve) => {
    setTimeout(() => {
      if(data.score >= 90) {
        resolve(`${data.name}ç²å¾—é›»å½±ç¥¨`);
      } else if(data.score >= 20 && data.score <90) {
        resolve(`${data.name}ç²å¾—å˜‰ç`);
      } else {
        reject("ä½ æ²’æœ‰çå“")
      }
    }, 1000);
  });
};

correctTest("å°æ˜")
  .then((data) => {
    return checkReward(data);
  }) //åªè¦ä½ åœ¨ then è£¡ return Promise
  .then((reward) => {
    //å¤–å±¤ then å°±æœƒã€Œç­‰é€™å€‹ Promise çµæŸã€
    console.log(reward);
  })
  .catch((error) => {
    console.log(error);
  });
```

### 4ï¸âƒ£ async. await

```js
const correctTest = (name) => {
  console.log("æ‰¹æ”¹æˆç¸¾ä¸­");

  return new Promise((resolve, reject) => {
    setTimeout(() => {
      const score = Math.round(Math.random() * 100);

      if (score >= 20) {
        resolve({ name, score });
      } else {
        reject("ä½ å·²é”åˆ°é€€å­¸é–€æª»");
      }
    }, 1000);
  });
};

const checkReward = (data) => {
  console.log("æ­£åœ¨æª¢æŸ¥èª°æŠ½ä¸­çä¸­");

  return new Promise((resolve) => {
    setTimeout(() => {
      if (data.score >= 90) {
        resolve(`${data.name}ç²å¾—é›»å½±ç¥¨`);
      } else if (data.score >= 60 && data.score < 90) {
        resolve(`${data.name}ç²å¾—å˜‰ç`);
      } else {
        reject("ä½ æ²’æœ‰çå“ï¼Œæ‰“æ‰‹10ä¸‹");
      }
    }, 1000);
  });
};

// correctTest("å°æ˜")
//   .then((data) => {
//     return checkReward(data);
//   }) //åªè¦ä½ åœ¨ then è£¡ return Promise
//   .then((reward) => {
//     //å¤–å±¤ then å°±æœƒã€Œç­‰é€™å€‹ Promise çµæŸã€
//     console.log(reward);
//   })
//   .catch((error) => {
//     console.log(error);
//   });

const init = async function () {
  try {
    const studentA = await correctTest("å°æ˜");
    const rewardA = await checkReward(studentA);
    console.log(rewardA);
  } catch (error) {
    console.log(error);
  }
};

init();

```



---

## ğŸŸ¦ promise.all

```js
const correctTest = (name) => {
  console.log("æ‰¹æ”¹æˆç¸¾ä¸­");

  return new Promise((resolve, reject) => {
    setTimeout(() => {
      const score = Math.round(Math.random() * 100);
      resolve({ name, score });

    }, Math.random() * 10000);
  });
};

Promise.all([correctTest('sui'),correctTest('ii'),correctTest('xx')])
  .then(data => console.log(data))
```


---

## ğŸŸ¦ fetch èˆ‡ promiseçš„é—œä¿‚

```js
const url = `https://raw.githubusercontent.com/hexschool/2021-ui-frontend-job/master/frontend_data.json`

fetch(url)
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.log(error))
```
<iframe height="300" style={{ width: "100%" }} scrolling="no" title="Untitled" src="https://codepen.io/sui-hsialn/embed/ByzRzgB?default-tab=js" frameborder="no" loading="lazy" allowtransparency="true">
      See the Pen <a href="https://codepen.io/sui-hsialn/pen/ByzRzgB">
  Untitled</a> by Sui Hsilan (<a href="https://codepen.io/sui-hsialn">@sui-hsialn</a>)
  on <a href="https://codepen.io">CodePen</a>.
      </iframe>

---

## ğŸŸ¦ å˜—è©¦å¯« axios.get å¥—ä»¶åŠŸèƒ½