---
title: "ã€AJAX_ES5ã€‘ä½¿ç”¨(XHR)XMLHttpRequesç™¼é€ Ajax Call"
sidebar_position: 2
---

## ğŸŸ§ ç™¼é€ajax call: XHRè«‹æ±‚

> å…ˆæ¸¬è©¦ç¬¬ä¸€ä»£çš„ AJAX call ç™¼é€ XHR(XMLHttpRequest)è«‹æ±‚

:::note

- url æˆ‘æƒ³ç©å…©ç¨®ï¼š
  - [å…­è§’æä¾›](https://raw.githubusercontent.com/hexschool/2021-ui-frontend-job/master/frontend_data.json)

- [REST Countries API](https://restcountries.com/)
  - æˆ‘æƒ³è¦å¾APIè£¡æ‹¿åˆ°æŸåœ‹å®¶çš„ç›¸é—œè³‡æ–™
:::

---

### 1ï¸âƒ£ å®šç¾©æµç¨‹

```
1. å»ºç«‹ä¸€å€‹ XMLHttpRequest ç‰©ä»¶
2. è¨­å®šç™¼é€ç¶²è·¯è«‹æ±‚çš„æ–¹æ³• èˆ‡ è¨­å®šç¶²å€ .open()
3. åªæ˜¯ã€Œé–‹å§‹è«‹æ±‚ã€ .send() ==> request.send() ä¸¦ä¸æœƒç­‰è³‡æ–™å›ä¾†
4. ç€è¦½å™¨åœ¨èƒŒæ™¯ç™¼é€ HTTP request(ç¶²è·¯è«‹æ±‚æ˜¯éåŒæ­¥)
5. ä¼ºæœå™¨å›æ‡‰è³‡æ–™
6. è¨»å†Šä¸€å€‹ callbackï¼ˆload äº‹ä»¶ï¼‰
7. ç€è¦½å™¨æ¥æ”¶å®Œæ•´ response
8. ğŸ‘‰ è§¸ç™¼ load äº‹ä»¶ => è¨»å†Š load äº‹ä»¶ callbackï¼ˆé€é addEventListenerï¼‰
```

:::danger
âœ” send() ä¸æœƒç­‰å¾…è³‡æ–™ => éåŒæ­¥

âœ” ä¸€åˆ‡éƒ½è¦é  è¨­è¨ˆload callback ä¾†æ¥çµæœ

- load äº‹ä»¶è§¸ç™¼çš„æ¢ä»¶æ˜¯ï¼š
  - âœ” è«‹æ±‚æˆåŠŸé€å‡º
  - âœ” ä¼ºæœå™¨å·²å›æ‡‰
  - âœ” å›æ‡‰å…§å®¹ å®Œæ•´æ¥æ”¶å®Œæˆ
  - âœ” responseText å·²å¯å®‰å…¨è®€å–
   - ğŸ‘‰ é€™æ™‚æ‰èƒ½ JSON.parse()
:::

| äº‹ä»¶                 | ä»€éº¼æ™‚å€™è§¸ç™¼ | èªªäººè©±    |
| ------------------ | ------ | ------ |
| `load`             | å›æ‡‰å®Œæ•´æ”¶åˆ° | è³‡æ–™å¯ä»¥ç”¨äº† |
| `error`            | ç¶²è·¯éŒ¯èª¤   | è«‹æ±‚å¤±æ•—   |
| `timeout`          | è¶…éæ™‚é–“   | ç­‰å¤ªä¹…    |
| `abort`            | è¢«å–æ¶ˆ    | è¢«ä¸­æ–·    |
| `readystatechange` | ç‹€æ…‹æ”¹è®Š   | ä½éšæµç¨‹   |


### 2ï¸âƒ£ å°æ‡‰ç¨‹å¼ç¢¼ï¼š


```js
"use strict";

// ES5æ–¹å¼ï¼šä½¿ç”¨ XMLHttpRequest ç™¼é€ GET è«‹æ±‚
const request = new XMLHttpRequest();

// è¨­å®šè«‹æ±‚ï¼ˆæ–¹æ³• + URLï¼‰
request.open("GET", "https://restcountries.com/v3.1/name/portugal");

// âš ï¸ éåŒæ­¥|ç™¼é€è«‹æ±‚ï¼ˆéåŒæ­¥ï¼Œä¸æœƒç­‰å¾…å›å‚³ï¼‰
request.send();

// è¨»å†Š callbackï¼Œç­‰å¾…è³‡æ–™å›ä¾†
request.addEventListener("load", function () {
  console.log(this); // XMLHttpRequest instance
  // const data = JSON.parse(this.responseText);
});
```

<iframe
  height="300"
  style={{ width: "100%" }}
  scrolling="no"
  title="XHR AJAX Demo"
  src="https://codepen.io/sui-hsialn/embed/ZYOeBbP?default-tab=js"
  frameBorder="0"
  loading="lazy"
  allowFullScreen
/>


ğŸ”¹ è£œå…… 1ï¼šç‚ºä»€éº¼ send ä¸ç­‰è³‡æ–™ï¼Ÿ
> å› ç‚º Ajax æ˜¯éåŒæ­¥è«‹æ±‚ï¼Œ .send() çš„è·è²¬åªæ˜¯ã€Œé€å‡ºè«‹æ±‚ã€ï¼Œè³‡æ–™æœƒåœ¨èƒŒæ™¯å‚³è¼¸ï¼ŒJavaScript ä¸»åŸ·è¡Œç·’ä¸æœƒè¢«é˜»å¡ã€‚


ğŸ”¹ è£œå…… 2ï¼šç‚ºä»€éº¼ä¸€å®šè¦ callbackï¼Ÿ
> å› ç‚ºè³‡æ–™ã€Œä»€éº¼æ™‚å€™å›ä¾†ã€æ˜¯ç„¡æ³•é æœŸçš„ï¼ŒJavaScript åªèƒ½å…ˆè¨»å†Šä¸€å€‹ callbackï¼Œç­‰ä¼ºæœå™¨å›æ‡‰å®Œæˆæ™‚ï¼Œå†ç”±ç€è¦½å™¨å‘¼å«é€™å€‹å‡½å¼ä¾†è™•ç†çµæœã€‚

- ä¹Ÿå°±æ˜¯èªªï¼Œåœ¨ Ajax ä¸­ï¼š
  - æˆ‘å…ˆå®šç¾©ã€Œè³‡æ–™å›ä¾†å¾Œè¦åšä»€éº¼ã€
  - ä½†ä¸æ˜¯æˆ‘æ±ºå®šã€Œä»€éº¼æ™‚å€™åšã€

ğŸ”¹ è£œå…… 3ï¼šç‚ºä»€éº¼ç¾åœ¨ä¸å¸¸ç”¨ XHRï¼Ÿ
> å› ç‚ºè³‡æ–™å›ä¾†çš„æ™‚é–“ä¸ç¢ºå®šï¼Œåªèƒ½åœ¨äº‹ä»¶ç™¼ç”Ÿæ™‚è™•ç†çµæœã€‚

| å•é¡Œ          | èªªæ˜     |
| ----------- | ------ |
| å¯è®€æ€§å·®        | æµç¨‹è¢«æ‹†æ•£  |
| å·¢ç‹€ callback | é›£ç¶­è­·    |
| éŒ¯èª¤è™•ç†éº»ç…©      | å¿…é ˆæ‰‹å‹•åˆ¤æ–· |

:::tip

XMLHttpRequest å®Œå…¨åŸºæ–¼äº‹ä»¶èˆ‡ callback è¨­è¨ˆï¼Œ

ç•¶éåŒæ­¥æµç¨‹è®Šå¤šæ™‚ï¼Œç¨‹å¼ç¢¼å®¹æ˜“è¢«æ‹†æ•£ã€å·¢ç‹€åŒ–ï¼Œ

å¯è®€æ€§èˆ‡ç¶­è­·æ€§éƒ½æœƒå¿«é€Ÿä¸‹é™ã€‚

ğŸ‘‰ ES6 Promise / async await å°±æ˜¯ç‚ºäº†è§£æ±ºé€™äº›å•é¡Œ
:::

### 3ï¸âƒ£ å…ˆæŠŠè«‹æ±‚åŒ…æˆå‡½å¼

```js 
"use strict";

const getCountryAndNeighbour = function (country) {
  //es5çš„æ–¹å¼ ç™¼é€GETè«‹æ±‚
  //AJAX CALL 1
  const request = new XMLHttpRequest();
  request.open("GET", `https://restcountries.com/v3.1/name/${country}`);
  request.send(); //éåŒæ­¥å‚³é€è«‹æ±‚åˆ°å¾Œç«¯

  //äº‹ä»¶é©…å‹•(loadäº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œèª¿ç”¨callback)
  request.addEventListener("load", function () {
    //console.log("this", this); //xhrç‰©ä»¶
    const [data] = JSON.parse(this.responseText); //responseTextç‰©ä»¶åŒ…åœ¨[] éœ€è¦çš„è³‡æ–™æ ¼å¼æ˜¯é™£åˆ—
    console.log("data", data);
    console.log("data", data.name.common);
  });
};

getCountryAndNeighbour("portugal");

```

### 4ï¸âƒ£ å›å‘¼åœ°ç„ï¼ˆã€Œå–®ä¸€è«‹æ±‚ â†’ ç›¸ä¾è«‹æ±‚ã€çš„çœŸå¯¦ç—›é»ï¼‰
æˆ‘æ‹¿åˆ°äº†portugalè©²åœ‹çš„è³‡æ–™ï¼Œæˆ‘æƒ³è¦ä¾æ“šè©²åœ‹å®¶å»æŠ“å®ƒé„°åœ‹çš„è³‡æ–™å‘¢ï¼Ÿ
- æˆ‘ç¬¬äºŒæ¬¡çš„è«‹æ±‚ä¾è³´å‰ä¸€æ¬¡è«‹æ±‚çš„å›å‚³çµæœ
  - ä¸€æ¨£å…ˆä½¿ç”¨XHRä¾†åšï¼š

```js
"use strict";

const getCountryAndNeighbour = function (country) {
  //es5çš„æ–¹å¼ ç™¼é€GETè«‹æ±‚
  //AJAX CALL 1
  const request = new XMLHttpRequest();
  request.open("GET", `https://restcountries.com/v3.1/name/${country}`);
  request.send(); //éåŒæ­¥å‚³é€è«‹æ±‚åˆ°å¾Œç«¯

  //äº‹ä»¶é©…å‹•(loadäº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œèª¿ç”¨callback)
  request.addEventListener("load", function () {
    //console.log("this", this); //xhrç‰©ä»¶
    const [data] = JSON.parse(this.responseText); //responseTextç‰©ä»¶åŒ…åœ¨[] éœ€è¦çš„è³‡æ–™æ ¼å¼æ˜¯é™£åˆ—
    console.log("data", data);
    console.log("data", data.name.common);

    //é€™è£¡æˆ‘å·²ç¶“å¾—åˆ°å‰ä¸€æ¬¡çš„è«‹æ±‚å›å‚³ï¼ˆè¥¿ç­ç‰™çš„è³‡æ–™ï¼‰
    //[å–çš„é„°åœ‹çš„è³‡æ–™] è¦åœ¨ç™¼å‡ºç¬¬äºŒæ¬¡è«‹æ±‚ï¼Œä¾è³´å‰ä¸€æ¬¡è«‹æ±‚çš„å›å‚³
    //console.log(data.borders?.[0]);
    const [neighbour] = data.borders;
    console.log(neighbour);

    if (!neighbour) return;

    //AJAX CALL 2
    const request2 = new XMLHttpRequest();
    request2.open("GET", `https://restcountries.com/v3.1/name/${neighbour}`);
    request2.send(); //éåŒæ­¥å‚³é€è«‹æ±‚åˆ°å¾Œç«¯

    //äº‹ä»¶é©…å‹•(loadäº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œèª¿ç”¨callback)
    request2.addEventListener("load", function () {
      //console.log("this", this); //xhrç‰©ä»¶
      const [data2] = JSON.parse(this.responseText); //responseTextç‰©ä»¶åŒ…åœ¨[] éœ€è¦çš„è³‡æ–™æ ¼å¼æ˜¯é™£åˆ—
      console.log("data2", data2);
      console.log("data2", data2.name.common);
    });
  });
};

getCountryAndNeighbour("portugal");

```

> é€™è£¡å¯ä»¥æ¸¬è©¦çµæœ
<iframe height="300" style={{ width: "100%" }} scrolling="no" title="callback hell xhr" src="https://codepen.io/sui-hsialn/embed/XJKMMBy?default-tab=js" frameborder="no" loading="lazy" allowtransparency="true">
      See the Pen <a href="https://codepen.io/sui-hsialn/pen/XJKMMBy">
  callback hell xhr</a> by Sui Hsilan (<a href="https://codepen.io/sui-hsialn">@sui-hsialn</a>)
  on <a href="https://codepen.io">CodePen</a>.
</iframe>

ğŸ‘‰ ç‚ºä»€éº¼ load æœƒå°è‡´ callback hellï¼Ÿ
- å› ç‚ºï¼š
  - load æ˜¯ã€Œäº‹ä»¶ã€
  - äº‹ä»¶åªèƒ½ã€Œç™¼ç”Ÿæ™‚è¢«å‹•é€šçŸ¥ã€
  - å¦‚æœä¸‹ä¸€å€‹è«‹æ±‚ ä¾è³´ä¸Šä¸€å€‹çµæœ
  - å°±åªèƒ½ã€Œäº‹ä»¶è£¡å†è¨»å†Šäº‹ä»¶ã€
`load â†’ load â†’ load â†’ ...`
  - ğŸ‘‰ æ˜¯ äº‹ä»¶æ¨¡å‹æœ¬èº«çš„é™åˆ¶

:::tip
XMLHttpRequest æ˜¯ç¬¬ä¸€ä»£ AJAX è§£æ³•ï¼Œå®Œå…¨åŸºæ–¼äº‹ä»¶èˆ‡ callbackã€‚

.send() åªè² è²¬é€å‡ºè«‹æ±‚ï¼Œå¯¦éš›ç¶²è·¯å‚³è¼¸ç”±ç€è¦½å™¨è™•ç†ï¼Œ

JavaScript åªèƒ½é€éè¨»å†Š load äº‹ä»¶ä¾†æ¥æ”¶çµæœã€‚

ç•¶è«‹æ±‚ä¹‹é–“ç”¢ç”Ÿä¾è³´é—œä¿‚æ™‚ï¼Œcallback æœƒå¿«é€Ÿå·¢ç‹€åŒ–ï¼Œ

é€™å°±æ˜¯å¾Œä¾† Promise èˆ‡ async/await å‡ºç¾çš„åŸå› ã€‚
:::

:::tip
åœ¨ XHR ä¸­ï¼ŒéåŒæ­¥æµç¨‹æ˜¯ã€Œäº‹ä»¶é©…å‹•ã€çš„ï¼Œ

XHRï¼šäº‹ä»¶ç™¼ç”Ÿ â†’ callback

Promiseï¼šç‹€æ…‹æ”¹è®Š â†’ resolve value

async/awaitï¼šçœ‹èµ·ä¾†åƒåŒæ­¥ï¼Œå…¶å¯¦é‚„æ˜¯ Promis
:::


> load æ˜¯ç€è¦½å™¨åœ¨éåŒæ­¥è«‹æ±‚å®Œæˆå¾Œç™¼å‡ºçš„é€šçŸ¥äº‹ä»¶ï¼Œ

> JavaScript åªèƒ½è¢«å‹•æ¥æ”¶ï¼Œç„¡æ³•ä¸»å‹•ç­‰å¾…ï¼Œ

> é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¾Œä¾†éœ€è¦ Promise èˆ‡ async/await ä¾†æ”¹å¯«éåŒæ­¥æµç¨‹ã€‚

## ğŸŸ¦ ç”¨setTimeOut()å†è§£é‡‹ä¸€æ¬¡

```js
setTimeout(() => {
  console.log('éäº† 1 ç§’');

  setTimeout(() => {
    console.log('éäº† 2 ç§’');

    setTimeout(() => {
      console.log('éäº† 3 ç§’');

      setTimeout(() => {
        console.log('éäº† 4 ç§’');
      }, 1000);

    }, 1000);

  }, 1000);

}, 1000);

// "éäº† 1 ç§’"
// "éäº† 2 ç§’"
// "éäº† 3 ç§’"
// "éäº† 4 ç§’"
```
- ç™¼ç”Ÿäº†ä»€éº¼ï¼ˆDo Whatï¼‰
  - ğŸ‘‰ æ¯ä¸€å€‹ setTimeout éƒ½åœ¨ç­‰ä¸Šä¸€å€‹å®Œæˆå¾Œæ‰åŸ·è¡Œ
  - setTimeout æ˜¯ éåŒæ­¥
  - JavaScript ä¸æœƒç­‰
  - å¦‚æœä½ æƒ³è¦ã€Œé †åºåŸ·è¡Œã€ï¼Œåªèƒ½ï¼š
  - ğŸ‘‰ æŠŠä¸‹ä¸€æ­¥å¯«åœ¨ callback è£¡

- çµæ§‹å°±æœƒè®Šï¼š(å‘¼æ‡‰å‰é¢çš„XHRå›å‘¼åœ°ç„)
```
setTimeout
  â””â”€ setTimeout
       â””â”€ setTimeout
            â””â”€ setTimeout
```

```
ä¸»ç¨‹å¼è·‘å®Œ
â†“
1 ç§’åˆ° â†’ åŸ·è¡Œç¬¬ä¸€å€‹ callback
â†“
å†è¨»å†Šä¸€å€‹ setTimeout
â†“
1 ç§’åˆ° â†’ åŸ·è¡Œç¬¬äºŒå€‹ callback
â†“
å†è¨»å†Šä¸€å€‹ setTimeout
â†“
...

```
> setTimeout ä¸¦ä¸æœƒé˜»å¡ä¸»ç¨‹å¼ï¼Œè€Œæ˜¯æŠŠ callback è¨»å†Šåˆ°äº‹ä»¶ä½‡åˆ—ï¼Œç­‰æ™‚é–“åˆ°æ‰åŸ·è¡Œã€‚

> æ‰€ä»¥ ES6 æ‰å¼•å…¥ Promiseï¼ŒES2017 æ‰æœ‰ async / await

### 0ï¸âƒ£ æ”¹å¯«æˆ ES6 Promise

```js
const wait = seconds =>
  new Promise(resolve => setTimeout(resolve, seconds * 1000));

wait(1)
  .then(() => {
    console.log('1 second passed');
    return wait(1);
  })
  .then(() => {
    console.log('2 seconds passed');
    return wait(1);
  })
  .then(() => {
    console.log('3 seconds passed');
    return wait(1);
  })
  .then(() => {
    console.log('4 seconds passed');
  });

```

<iframe height="300" style={{ width: "100%" }} scrolling="no" title="Untitled" src="https://codepen.io/sui-hsialn/embed/MYemWyY?default-tab=js" frameborder="no" loading="lazy" allowtransparency="true">
      See the Pen <a href="https://codepen.io/sui-hsialn/pen/MYemWyY">
  Untitled</a> by Sui Hsilan (<a href="https://codepen.io/sui-hsialn">@sui-hsialn</a>)
  on <a href="https://codepen.io">CodePen</a>.
      </iframe>


### 1ï¸âƒ£ æ”¹å¯« async / await 




### æ™‚åºåœ–

```mermaid
flowchart TD
    A[ä¸»ç¨‹å¼é–‹å§‹åŸ·è¡Œ] --> B[è¨»å†Šç¬¬ä¸€å€‹è¨ˆæ™‚å™¨ä¸€ç§’]
    B --> C[ä¸»ç¨‹å¼çµæŸ]

    C --> D[ä¸€ç§’åˆ°æœŸ]
    D --> E[ç¬¬ä¸€å€‹ callback é€²å…¥ä»»å‹™ä½‡åˆ—]

    E --> F[Call Stack ç©º]
    F --> G[åŸ·è¡Œç¬¬ä¸€å€‹ callback]
    G --> H[è¨»å†Šç¬¬äºŒå€‹è¨ˆæ™‚å™¨ä¸€ç§’]

    H --> I[ä¸€ç§’åˆ°æœŸ]
    I --> J[ç¬¬äºŒå€‹ callback é€²å…¥ä»»å‹™ä½‡åˆ—]

    J --> K[Call Stack ç©º]
    K --> L[åŸ·è¡Œç¬¬äºŒå€‹ callback]
    L --> M[è¨»å†Šç¬¬ä¸‰å€‹è¨ˆæ™‚å™¨ä¸€ç§’]

    M --> N[ä¸€ç§’åˆ°æœŸ]
    N --> O[ç¬¬ä¸‰å€‹ callback é€²å…¥ä»»å‹™ä½‡åˆ—]

    O --> P[Call Stack ç©º]
    P --> Q[åŸ·è¡Œç¬¬ä¸‰å€‹ callback]
    Q --> R[è¨»å†Šç¬¬å››å€‹è¨ˆæ™‚å™¨ä¸€ç§’]

    R --> S[ä¸€ç§’åˆ°æœŸ]
    S --> T[ç¬¬å››å€‹ callback é€²å…¥ä»»å‹™ä½‡åˆ—]

    T --> U[Call Stack ç©º]
    U --> V[åŸ·è¡Œç¬¬å››å€‹ callback]

    classDef main fill:#E3F2FD,stroke:#1E88E5,stroke-width:2px
    classDef timer fill:#FFF3E0,stroke:#EF6C00,stroke-width:2px
    classDef queue fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px
    classDef stack fill:#FCE4EC,stroke:#C2185B,stroke-width:2px

    class A,B,C main
    class D,I,N,S timer
    class E,J,O,T queue
    class F,G,K,L,P,Q,U,V stack

```