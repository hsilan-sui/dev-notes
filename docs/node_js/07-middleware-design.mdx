---
title: "ã€Express_middlewareã€‘middleware ç•°å¸¸ç‹€æ…‹è™•ç†"
sidebar_position: 8
---


## ğŸŸ§ èªè­˜expressä¸­çš„app.use()

:::tip
- `app.use()`
- `use` ç”¨çš„åªæœ‰å…©ç¨®æ±è¥¿ï¼š
  - `middleware`
  - `router`

:::

- <Highlight>app.use æ˜¯ã€Œæ› middleware æˆ– router çš„åœ°æ–¹ã€
æ„æ€æ˜¯ï¼šç¬¦åˆæ¢ä»¶çš„è«‹æ±‚ï¼Œé€²ä¾†ä¸€å®šæœƒå…ˆè·‘å®ƒ</Highlight>

### 0ï¸âƒ£ æœ€åŸºæœ¬çš„ app.useï¼ˆå…¨åŸŸ middlewareï¼‰
```bash
app.use(express.json());
```
- æ‰€æœ‰é€²ä¾†çš„è«‹æ±‚ï¼Œéƒ½å…ˆå¹«æˆ‘æŠŠ body è§£ææˆ JSON(è«‹æ±‚streamåªæœƒå‚³å­—ä¸²æ ¼å¼)

```
ä»»ä½• request
  â†“
express.json()
  â†“
å¾Œé¢çš„ route / handler

```

- ğŸ‘‰ ä¸ç®¡æ˜¯ /events é‚„æ˜¯ /users è·¯ç”±ï¼Œéƒ½æœƒè·‘express.json()

### 1ï¸âƒ£ app.use('/path', middleware)ï¼ˆæŒ‡å®šè·¯å¾‘ï¼‰
```bash
app.use('/events', authMiddleware);
```
- <Highlight>åªè¦è·¯å¾‘æ˜¯ /events é–‹é ­çš„è«‹æ±‚ï¼Œéƒ½è¦å…ˆè·‘ authMiddleware</Highlight>
- ä¾‹å¦‚ä»¥ä¸‹é€™äº›/events é–‹é ­çš„è«‹æ±‚è·¯ç”±ï¼Œä¸€å®šæœƒç¶“éauthMiddlewareé©—è­‰
```bash
/events
/events/123
/events/123/plans
```

### 2ï¸âƒ£ å¦å¤–çš„æ‡‰ç”¨ï¼šapp.use('/path', router)ï¼ˆæ› Routerï¼‰
```bash
app.use('/events', eventRouter);

```
- åªè¦è«‹æ±‚è·¯å¾‘æ˜¯ `/events` é–‹é ­ï¼Œå°±äº¤çµ¦ eventRouter è™•ç†å¾ŒçºŒè·¯ç”±ï¼Œé€™æ™‚å€™ çœŸæ­£çš„è·¯ç”±å®šç¾©åœ¨ router è£¡ã€‚


### 3ï¸âƒ£ app.use + middleware + routerï¼ˆæœ€å¸¸è¦‹æ‡‰ç”¨ï¼‰

```bash
app.use('/events', authMiddleware, eventRouter);
```

- è·¯å¾‘æ˜¯ `/events` é–‹é ­
  - å…ˆè·‘ `authMiddleware`
  - `next()` => å†é€² `eventRouter`

- æµç¨‹ï¼š
```
GET /events/123
  â†“
authMiddleware
  â†“
eventRouter
  â†“
handler
```


| å¯«æ³•                      | æ„æ€             |
| ----------------------- | -------------- |
| `app.use(mw)`           | å…¨éƒ¨è«‹æ±‚éƒ½è·‘         |
| `app.use('/x', mw)`     | `/x` é–‹é ­æ‰è·‘      |
| `app.use('/x', router)` | `/x` äº¤çµ¦ router |


## ğŸŸ¦ middleware ä¸­ä»‹è»Ÿé«”



- ![express_01](/img/express_01.png)

- åŠ å…¥middleware
  - ![express_02](/img/express_02.png)

- [ä¸Šè¿°åœ–çš†æ“·å–è‡ªZTM-Node.js Zero to Mastery]



### 0ï¸âƒ£ next()å‡½å¼çš„é‡è¦æ€§

- > <Highlight color="#6A1B9A">next() æ˜¯ä¸€å€‹ functionï¼Œæ„æ€åªæœ‰ä¸€å€‹ï¼š</Highlight>

- > <Highlight color="#6A1B9A">ã€Œæˆ‘é€™ä¸€é—œè™•ç†å®Œäº†ï¼Œè«‹äº¤çµ¦ä¸‹ä¸€é—œã€</Highlight>


- middleware ä¸­çš„`next()`å‡½å¼ï¼Œå¦‚æœæ²’æœ‰å¯«ä¸Šï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ

:::tip èˆ‰æˆ‘ç”Ÿæ´»å®¶ä¸­å¤§æ¨“ç™¼ç”Ÿçš„ä¾‹å­

- æˆ‘é–‹è»Šè¦å›å¤§æ¨“çš„åœ°ä¸‹å®¤ï¼Œé€™æ™‚æœƒæ„Ÿæ¸¬å™¨æœƒæ„Ÿæ‡‰æˆ‘è»Šä¸Šçš„etag idæ¯”å°ç³»çµ±æ˜¯å¦æœ‰è¨»å†Šï¼Œç¢ºèªå·²ç¶“è¨»å†Šæ¯”å°æˆåŠŸ(æœƒäº®ç¶ è‰²ç‡ˆï¼Œé€šè¡Œç§’æ•¸é¡¯ç¤º20ç§’)ï¼Œä½†æ˜¯é€™æ™‚å€™æ²’æœ‰åœ¨æ¯”å°æˆåŠŸå¾Œï¼Œå¯«ä¸Š`next()`

- é‚£æˆ‘æ¯”å°æˆåŠŸçš„ç‹€æ…‹ï¼Œå°±ä¸æœƒè¢«æ‹‹åˆ°é–˜é–€é¦¬é”è™•ç†ï¼Œå› æ­¤æˆ‘å®¶åœ°ä¸‹å®¤çš„é–˜é–€å¸¸å¸¸æ‰“ä¸é–‹ï¼Œå³ä½¿etag idæ¯”å°æˆåŠŸï¼Œé€™æ™‚å¾Œå°±æœƒå‡ºç¾ç‹€æ…‹æ˜¯è½‰åœˆåœˆè™•ç†ä¸­ing
:::

- ETag æ„Ÿæ‡‰æˆåŠŸï¼ˆäº®ç¶ ç‡ˆï¼‰ï¼ middleware æ¢ä»¶æˆç«‹
- ä½†æ²’æœ‰è§¸ç™¼é¦¬é”ï¼æ²’æœ‰å‘¼å« next()
- æ‰€ä»¥æµç¨‹è¢«å¡ä½
  - â¡ï¸ request è¢«æ””æˆª
  - â¡ï¸ handler æ°¸é ä¸æœƒè¢«å‘¼å«


- gpt å¹«æˆ‘æ•´ç†ä¸Šé¢çš„ç¸½çµ:
> ETag æ„Ÿæ‡‰ç³»çµ±åœ¨é©—è­‰æˆåŠŸå¾Œï¼Œè‹¥æœªè§¸ç™¼å¾ŒçºŒé¦¬é”æ§åˆ¶è¨Šè™Ÿï¼Œæ•´å€‹æµç¨‹å°±æœƒåœåœ¨é©—è­‰å±¤ï¼›middleware è‹¥æœªå‘¼å« next()ï¼Œè«‹æ±‚åŒæ¨£ç„¡æ³•é€²å…¥å¾ŒçºŒè™•ç†éšæ®µ



---

## ğŸŸ¦ ä»¥éœ²ç‡Ÿå°ˆæ¡ˆçš„app.js middlewareä¾†ç•«åœ–

- ç¨‹å¼ç¢¼ï¼š
```jsx title="app.js"
const dotenv = require("dotenv");
const express = require("express");
const cors = require("cors");
const path = require("path");
const pinoHttp = require("pino-http");

const logger = require("./utils/logger")("App");
const authRouter = require("./routes/authRouter");

const adminRouter = require("./routes/adminRouter");
const memberRouter = require("./routes/memberRouter");
const hostRouter = require("./routes/hostRouter");
const eventsRouter = require("./routes/eventsRouter");
const metaRouter = require("./routes/metaRouter");
const orderRouter = require("./routes/orderRouter");

const cookieParser = require("cookie-parser");
const setupSwagger = require("./swagger");
const passport = require("./config/passport");

require("./cron/updateEventStatus");

if (process.env.NODE_ENV !== "production") {
  dotenv.config({
    path: path.resolve(process.cwd(), ".env"),
  });
}

const app = express();

//  router è¨»å†Šä¹‹å‰
setupSwagger(app);

//middleware 
app.use(passport.initialize());
//=> é€™è£¡å†é€²éšè™•ç†cookie å…è¨±å‰ç«¯è«‹æ±‚å¸¶å…¥cookie (è£¡é¢å¤¾å¸¶token)

const allowedOrigins = [
  "https://camping-project-one.vercel.app", // å‰ç«¯
  "https://campingproject.retool.com", // Retool ç¶²åŸŸ
  "http://localhost:3000", // æœ¬åœ°æ¸¬è©¦ç”¨
  "https://everforest-backend.zeabur.app", // å¾Œç«¯æ‰“çµ¦å¾Œç«¯åšç¥¨åˆ¸æ ¸éŠ·ç”¨"
];

const corsOptions = {
  origin: function (origin, callback) {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error("Not allowed by CORS"));
    }
  },

  credentials: true, //å…è¨±å¸¶ä¸Šcookie
};

//middleware 
app.use(cookieParser()); //å…è¨±è®€å–cookie

//*** ç¬¬ 1 éšæ®µï¼šåŸºç¤å®‰å…¨èˆ‡è·¨åŸŸè¨­å®š ***
//middleware 
app.use(cors(corsOptions)); // è™•ç†è·¨åŸŸ //å…è¨±å‰ç«¯è«‹æ±‚å¸¶ä¸Šcookie
app.options("*", cors(corsOptions)); //é¡å¤–è™•ç† preflight é è«‹æ±‚ï¼ˆOPTIONSï¼‰é¿å… fetch POST å ± CORS éŒ¯

//middleware 
//*** ç¬¬ 2 éšæ®µï¼šè§£æè«‹æ±‚å…§å®¹ ***
// é™åˆ¶å‚³éä¾†çš„ JSON å¤§å°
app.use(express.json({ limit: "10kb" })); // é™åˆ¶ JSON è«‹æ±‚å¤§å°
app.use(express.urlencoded({ extended: false }));

// *** ç¬¬ 3 éšæ®µï¼šè¨˜éŒ„è«‹æ±‚ç´€éŒ„ï¼ˆLog middlewareï¼‰ ***
app.use(
  pinoHttp({
    logger,
    serializers: {
      req(req) {
        req.body = req.raw.body;
        return req;
      },
    },
  })
);

//middleware 
app.use(express.static(path.join(__dirname, "public")));

//*** ç¬¬ 4 éšæ®µï¼šè·¯ç”±è¨»å†Š ***
app.get("/", (req, res) => {
  res.send("åŒ—åå›› test test");
});

app.use("/api/v1/admin", adminRouter);

// /api/v1/auth (ç™»å…¥è¨»å†Š)
app.use("/api/v1/auth", authRouter);

// /api/v1/member (æœƒå“¡)
app.use("/api/v1/member", memberRouter);

// /api/v1/host (ä¸»è¾¦æ–¹)
app.use("/api/v1/host", hostRouter);

// /api/v1/events (éœ²ç‡Ÿæ´»å‹•äº‹ä»¶ |è¤‡æ•¸å‘½å(è³‡æºé›†åˆ)| è·¯ç”±ä¹Ÿå°æ‡‰api)
app.use("/api/v1/events", eventsRouter);

// /api/v1/meta (==>è·Ÿ EventTagï¼ˆæ´»å‹•æ¨™ç±¤ä¸»è¡¨ï¼‰è·¯ç”±ä¹Ÿå°æ‡‰api)
app.use("/api/v1/meta", metaRouter);

app.use("/api/v1/member/orders", orderRouter);

//*** ç¬¬ 5 éšæ®µï¼šå¥åº·æª¢æŸ¥ ***
app.get("/healthcheck", (req, res) => {
  res.status(200).send("OK ä½ å®¹å™¨è£¡çš„å¾Œç«¯ èˆ‡ å®¹å™¨è£¡çš„è³‡æ–™åº«éƒ½å¾ˆå¥åº·");
});

//***  ç¬¬ 6 éšæ®µï¼šè™•ç†æ‰¾ä¸åˆ°çš„è·¯ç”±ï¼ˆ404ï¼‰***
app.use((req, res, _next) => {
  return res.status(404).json({
    status: "error",
    message: "æ‰¾ä¸åˆ°æ­¤è·¯ç”±",
  });
});

//***  ç¬¬ 7 éšæ®µï¼šéŒ¯èª¤è™•ç† middlewareï¼ˆçµ‚ç«™ï¼‰***
app.use((err, req, res, _next) => {
  console.error("å…¨åŸŸéŒ¯èª¤è™•ç†å™¨:", err);

  res.status(err.statusCode || 500).json({
    status: "error",
    message: err.message || "ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦",
  });
});

module.exports = app;
```

- å–®å°±ä¸Šè¿°ç¨‹å¼ç¢¼çš„middlewareåšæµç¨‹ç•«åœ–
```mermaid
flowchart TD
    A[Request é€²å…¥ Express App]

    %% å•Ÿå‹•èˆ‡åˆå§‹åŒ–
    A --> S[Passport Initialize Middleware]

    %% ç¬¬ 1 éšæ®µ åŸºç¤å®‰å…¨
    S --> B[Cookie Parser Middleware]
    B --> C[CORS Middleware]
    C --> C1[Preflight OPTIONS Middleware]

    %% ç¬¬ 2 éšæ®µ è«‹æ±‚è§£æ
    C1 --> D[JSON Body Parser Middleware]
    D --> E[URL Encoded Parser Middleware]

    %% ç¬¬ 3 éšæ®µ ç´€éŒ„èˆ‡éœæ…‹è³‡æº
    E --> F[Request Log Middleware]
    F --> G[Static Asset Middleware]

    %% ç¬¬ 4 éšæ®µ Router åˆ†æµ
    G --> H[API Router åˆ†æµ Middleware]

    %% API v1 Router
    H -->|api admin| I[Admin Router Middleware]
    H -->|api auth| J[Auth Router Middleware]
    H -->|api member| K[Member Router Middleware]
    H -->|api host| L[Host Router Middleware]
    H -->|api events| M[Events Router Middleware]
    H -->|api meta| N[Meta Router Middleware]

    %% Member å­è·¯ç”±
    K -->|member orders| O[Order Router Middleware]

    %% Endpoint
    I --> P[Controller Handler Endpoint]
    J --> P
    K --> P
    L --> P
    M --> P
    N --> P
    O --> P

    %% Response
    P --> R[Response å›å‚³]

    %% 404
    H --> X[æ‰¾ä¸åˆ°è·¯ç”± Middleware]
    X --> R

    %% Error
    P -->|ç™¼ç”ŸéŒ¯èª¤| Z[å…¨åŸŸéŒ¯èª¤è™•ç† Middleware]
    Z --> R

    %% class
    classDef entry fill:#E3F2FD,stroke:#1E88E5
    classDef init fill:#E0F7FA,stroke:#00838F
    classDef security fill:#E8F5E9,stroke:#2E7D32
    classDef parser fill:#FFFDE7,stroke:#F9A825
    classDef logger fill:#F3E5F5,stroke:#6A1B9A
    classDef router fill:#E1F5FE,stroke:#0277BD
    classDef handler fill:#C8E6C9,stroke:#2E7D32
    classDef error fill:#FCE4EC,stroke:#C2185B

    class A entry
    class S init
    class B,C,C1 security
    class D,E parser
    class F logger
    class G,H,I,J,K,L,M,N,O router
    class P handler
    class X,Z error

```
